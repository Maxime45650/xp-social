<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>XP Social</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="XP Social">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIgZmlsbD0iIzAwNjlGNiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0zMS4xIDY4LjRMMzYgNTQuN2wtNi44LTExLjJoNC42bDQuNiA4IDQuNS04aDQuN3wtNi44IDExLjEgNC44IDEzLjdoLTQuOWwtMy4yLTguOS0zLjEgOC45ek01My4zIDY4LjVWNDEuN2g0Ljl2OC42aDcuMXY0LjZoLTcuMXY4LjdjMCAxLjkuNiAyLjggMi40IDIuOGgxLjN2NC41eiIvPjwvc3ZnPg==">
<link rel="manifest" id="manifest">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@700;800&display=swap" rel="stylesheet">
<style>
:root {
    --primary: #0069F6;
    --primary-light: #E6F0FF;
    --secondary: #10B981;
    --accent: #8B5CF6;
    --ddr-primary: #FF416C;
    --ddr-secondary: #FF4B2B;
    --neutral-dark: #1F2937;
    --neutral-light: #F8FAFC;
    --neutral-border: #E2E8F0;
    --white: #FFFFFF;
    --success: #22C55E;
    --warning: #F59E0B;
    --bg-color: #F1F5F9;
    --scroll-y: 0;
}
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    -webkit-tap-highlight-color: transparent;
}
html {
    scroll-behavior: smooth;
}
body {
    background: var(--bg-color);
    color: var(--neutral-dark);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    overflow-x: hidden;
}
body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    top: var(--scroll-y);
}
.container {
    width: 100%;
    max-width: 440px;
    background: var(--white);
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, .08);
    position: relative;
    overflow: hidden;
    border: 1px solid var(--neutral-border);
}
@media (max-width: 500px) {
    .container {
        padding: 20px;
    }
}
header {
    text-align: center;
    margin-bottom: 24px;
    position: relative;
}
header h1 {
    font-family: 'Poppins', sans-serif;
    font-size: 34px;
    font-weight: 800;
    color: var(--neutral-dark);
    letter-spacing: -1.5px;
    margin-bottom: 8px;
}
header h1 span {
    color: var(--primary);
}
header p {
    color: #64748B;
    font-size: 14px;
    font-weight: 400;
}
.menu-btn {
    position: absolute;
    top: -4px;
    right: 0;
    background: var(--neutral-light);
    border: 1px solid var(--neutral-border);
    border-radius: 12px;
    width: 44px;
    height: 44px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 22px;
    cursor: pointer;
    transition: background .2s;
    line-height: 0;
    padding: 0;
}
.menu-btn:hover { background: #EBEFF5; }
.menu-btn:active { background: #DCE3ED; transform: scale(.98); }

.stats-display {
    background: var(--white);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 24px;
    border: 1px solid var(--neutral-border);
    position: relative;
    box-shadow: 0 4px 12px rgba(0, 0, 0, .03);
    text-align: center;
}
.progress-ring {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto 12px;
}
.progress-bg { fill: none; stroke: var(--neutral-border); stroke-width: 8; }
.progress-fill {
    fill: none;
    stroke: url(#gradient);
    stroke-width: 8;
    stroke-linecap: round;
    transform: rotate(-90deg);
    transform-origin: 50% 50%;
    transition: stroke-dashoffset .7s ease-in-out;
}
.level-inside {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 32px;
    font-weight: 800;
    color: var(--primary);
    font-family: 'Poppins', sans-serif;
    transition: transform .3s ease-in-out;
}
.level-inside.level-up { animation: levelUpBounce .5s ease-out; }
@keyframes levelUpBounce {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.3); }
    100% { transform: translate(-50%, -50%) scale(1); }
}
.xp-progress { margin-bottom: 16px; }
.xp-bar-container {
    background: var(--neutral-border);
    height: 10px;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 8px;
    position: relative;
}
.xp-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    border-radius: 10px;
    transition: width .7s cubic-bezier(.22, .61, .36, 1);
    position: relative;
    overflow: hidden;
}
.xp-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .4), transparent);
    animation: xpShine 1.5s infinite;
}
@keyframes xpShine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
.xp-text {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    font-weight: 500;
    color: #64748B;
    padding: 0 10px;
}
.xp-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    text-align: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--neutral-border);
}
.xp-summary-item h4 { font-size: 20px; font-weight: 700; color: var(--neutral-dark); }
.xp-summary-item p { font-size: 11px; font-weight: 500; text-transform: uppercase; color: #64748B; }
.xp-summary-item.streak h4,
.xp-summary-item.streak p { color: var(--warning); }
.xp-summary-item.abordages h4,
.xp-summary-item.abordages p { color: var(--primary); }
.xp-summary-item.abordages-today h4,
.xp-summary-item.abordages-today p { color: #25A6F7; }

.mode-switcher {
    display: flex;
    background-color: var(--neutral-light);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 24px;
    border: 1px solid var(--neutral-border);
}
.mode-btn {
    flex: 1;
    padding: 12px;
    border: none;
    background-color: transparent;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all .3s ease;
    color: #64748B;
    user-select: none;
    touch-action: manipulation;
}
.mode-btn.active {
    background-color: var(--white);
    color: var(--primary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, .07);
}
.mode-btn:not(.active):active { transform: scale(.98); }

.mode-container { display: none; }
.mode-container.active { display: block; }
.intro-text {
    font-size: 14px;
    font-weight: 500;
    color: #4B5563;
    margin-bottom: 16px;
    text-align: center;
}
#ddrModeContainer { text-align: center; }
#newInteractionBtn {
    font-size: 20px;
    font-weight: 700;
    font-family: 'Poppins', sans-serif;
    color: var(--white);
    background: linear-gradient(45deg, var(--ddr-primary), var(--ddr-secondary));
    border: none;
    border-radius: 16px;
    padding: 20px 40px;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(255, 65, 108, .4);
    transition: all .3s ease;
    animation: pulse 2s infinite;
    user-select: none;
    touch-action: manipulation;
}
#newInteractionBtn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 30px rgba(255, 65, 108, .5);
}
#newInteractionBtn:active {
    transform: translateY(0);
    box-shadow: 0 4px 12px rgba(255, 65, 108, .3);
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.actions-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
.action-btn {
    background: var(--white);
    border: 1px solid var(--neutral-border);
    border-radius: 12px;
    padding: 16px;
    color: var(--neutral-dark);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, .05);
    user-select: none;
    touch-action: manipulation;
}
.action-btn:hover {
    border-color: var(--primary-light);
    box-shadow: 0 6px 15px rgba(0, 105, 246, .12);
    transform: translateY(-2px);
}
.action-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 105, 246, .05);
    background: var(--neutral-light);
}
.action-btn.full-width { width: 100%; }
.btn-content { display: flex; align-items: center; gap: 12px; pointer-events: none; }
.btn-emoji { font-size: 24px; }
.btn-xp {
    background: var(--primary-light);
    color: var(--primary);
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 13px;
    font-weight: 600;
}

.daily-challenge {
    border: 1px solid var(--accent);
    border-radius: 12px;
    padding: 16px;
    margin-top: 24px;
    background: #faf5ff;
}
.daily-challenge h3 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--accent);
}
.daily-challenge p { font-size: 14px; }
.daily-challenge-btn {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    color: white;
    background-color: var(--accent);
    border: none;
    margin-top: 12px;
    cursor: pointer;
    transition: all .3s ease;
    user-select: none;
    touch-action: manipulation;
}
.daily-challenge-btn:hover:not(:disabled) { background-color: #7c3aed; }
.daily-challenge-btn:disabled { background-color: #a7a2b0; color: #e2e8f0; cursor: not-allowed; }
.daily-challenge-btn:active:not(:disabled) { background-color: #6d28d9; transform: scale(.98); }

.divider {
    width: 100%;
    height: 1px;
    background-color: var(--neutral-border);
    margin: 24px 0;
}
#undoBtn {
    width: 100%;
    background: transparent;
    border: 1px solid var(--neutral-border);
    border-radius: 10px;
    padding: 12px;
    color: #64748B;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s ease;
    user-select: none;
    touch-action: manipulation;
}
#undoBtn:hover { background: var(--neutral-light); border-color: var(--neutral-border); }
#undoBtn:active { background: #DCE3ED; transform: scale(.98); }

.instructions {
    margin-top: 20px;
    font-size: 12px;
    color: #94A3B8;
    text-align: center;
    line-height: 1.5;
    padding: 12px;
    background: var(--neutral-light);
    border-radius: 10px;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, .5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    visibility: hidden;
    opacity: 0;
    transition: opacity .3s, visibility .3s;
}
.modal.visible { visibility: visible; opacity: 1; }
.modal-content {
    background: var(--white);
    padding: 24px;
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(.95);
    transition: transform .3s cubic-bezier(.18, .89, .32, 1.28);
}
.modal.visible .modal-content { transform: scale(1); }
.close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: 20px;
    font-weight: bold;
    color: #64748B;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: var(--neutral-light);
    border-radius: 50%;
}
.close-btn:active { transform: scale(.98); }

.modal-content h2 {
    font-family: 'Poppins', sans-serif;
    font-size: 20px;
    margin-bottom: 20px;
    color: var(--primary);
}
.ddr-step { margin-bottom: 24px; }
.ddr-step h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--neutral-dark);
}
.girl-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.girl-type {
    border: 2px solid var(--neutral-border);
    border-radius: 12px;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: all .2s ease;
    user-select: none;
    position: relative;
    touch-action: manipulation;
}
.girl-type .emoji { font-size: 28px; pointer-events: none; }
.girl-type span, .girl-type p { pointer-events: none; }
.girl-type span {
    font-size: 13px;
    font-weight: 500;
    color: #4b5563;
    display: block;
    margin-top: 4px;
}
.girl-type p {
    font-size: 12px;
    font-weight: 600;
    margin-top: 2px;
    color: var(--primary);
}
.girl-type input { position: absolute; opacity: 0; width: 0; height: 0; }
.girl-type.selected {
    border-color: var(--ddr-primary);
    background-color: #fff0f5;
    transform: scale(1.05);
}
.girl-type:active { transform: scale(.98); }

.ddr-actions-list { display: flex; flex-direction: column; gap: 10px; }
.action-checkbox-label {
    display: flex;
    align-items: center;
    background-color: var(--neutral-light);
    padding: 12px;
    border-radius: 10px;
    cursor: pointer;
    border: 1px solid var(--neutral-border);
    transition: all .2s ease;
    user-select: none;
    touch-action: manipulation;
}
.action-checkbox-label .content {
    flex-grow: 1;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
    min-width: 0;
    pointer-events: none;
}
.action-checkbox-label .content span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.action-checkbox-label .xp-tag {
    background: var(--white);
    color: var(--primary);
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    border: 1px solid var(--neutral-border);
    flex-shrink: 0;
    pointer-events: none;
}
.action-checkbox-label input { display: none; }
.action-checkbox-label input:checked + .custom-checkbox {
    background-color: var(--ddr-primary);
    border-color: var(--ddr-primary);
    color: white;
}
.action-checkbox-label input:checked + .custom-checkbox::after { opacity: 1; }
.custom-checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid #cbd5e1;
    border-radius: 6px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all .2s;
    margin-right: 12px;
    flex-shrink: 0;
}
.custom-checkbox::after { content: '✔'; font-size: 14px; opacity: 0; transition: opacity .2s; }
.action-checkbox-label:active { transform: scale(.98); }
#ddrSubmitBtn {
    width: 100%;
    padding: 16px;
    font-size: 16px;
    font-weight: 700;
    color: var(--white);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    background: linear-gradient(45deg, var(--ddr-primary), var(--ddr-secondary));
    user-select: none;
    touch-action: manipulation;
}
#ddrSubmitBtn:active { transform: scale(.98); }

.badges-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 12px;
    text-align: center;
}
.badge-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    opacity: .3;
    transition: opacity .3s ease;
}
.badge-item.unlocked { opacity: 1; }
.badge-item .emoji { font-size: 36px; }
.badge-item p { font-size: 11px; font-weight: 600; color: var(--neutral-dark); }

.stats-content ul { list-style: none; padding: 0; }
.stats-content li {
    padding: 10px;
    border-bottom: 1px solid var(--neutral-border);
    font-size: 13px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.stats-content li:last-child { border-bottom: none; }
.export-btn-modal {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    color: var(--primary);
    background-color: var(--primary-light);
    border: none;
    margin-top: 20px;
    cursor: pointer;
    transition: background-color .3s ease;
    user-select: none;
    touch-action: manipulation;
}
.export-btn-modal:hover { background-color: #cfdcf4; }
.export-btn-modal:active { background-color: #b8c7e8; transform: scale(.98); }

.xp-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 14px 24px;
    background: var(--success);
    color: var(--white);
    border-radius: 14px;
    font-size: 18px;
    font-weight: 700;
    opacity: 0;
    transition: all .4s cubic-bezier(.18, .89, .32, 1.28);
    pointer-events: none;
    z-index: 1001;
    box-shadow: 0 10px 25px rgba(34, 197, 94, .35);
}
.xp-popup.show {
    opacity: 1;
    transform: translate(-50%, -150%);
}
.badge-unlocked-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(.8);
    width: 80%;
    max-width: 350px;
    background: linear-gradient(135deg, #1A202C, #2D3748);
    color: white;
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    opacity: 0;
    z-index: 1002;
    box-shadow: 0 12px 30px rgba(0, 0, 0, .5);
    transition: all .4s cubic-bezier(.18, .89, .32, 1.28);
}
.badge-unlocked-popup.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}
.badge-unlocked-popup .emoji {
    font-size: 60px;
    line-height: 1;
    margin-bottom: 8px;
}
.badge-unlocked-popup h3 {
    font-size: 20px;
    font-family: 'Poppins', sans-serif;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: gold;
}
.badge-unlocked-popup p { font-size: 14px; color: #CBD5E0; }
.confetti {
    position: fixed;
    width: 12px;
    height: 12px;
    opacity: 0;
    pointer-events: none;
    z-index: 998;
    animation: confettiFall 3s linear forwards;
}
@keyframes confettiFall {
    0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
    100% { transform: translateY(1000px) rotate(720deg); opacity: 0; }
}
</style>
</head>
<body>

<div class="container" id="appContainer">
    <header>
        <h1>XP <span>Social</span></h1>
        <p>Transforme tes interactions en jeu</p>
        <button id="menuBtn" class="menu-btn" aria-label="Ouvrir le menu">☰</button>
    </header>

    <section class="stats-display">
        <div class="progress-ring">
            <svg viewBox="0 0 70 70">
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#0069F6"/>
                        <stop offset="100%" stop-color="#8B5CF6"/>
                    </linearGradient>
                </defs>
                <circle class="progress-bg" r="31" cx="35" cy="35"></circle>
                <circle id="progressFill" class="progress-fill" r="31" cx="35" cy="35" stroke-dasharray="194.78" stroke-dashoffset="194.78"></circle>
            </svg>
            <div class="level-inside" id="levelNumber">1</div>
        </div>
        <div class="xp-progress">
            <div class="xp-bar-container">
                <div id="xpBar" class="xp-bar"></div>
            </div>
            <div class="xp-text">
                <span id="currentXP">0 XP</span>
                <span id="nextLevelXP">100 XP</span>
            </div>
        </div>
        <div class="xp-summary">
            <div class="xp-summary-item abordages"><h4 id="totalAbordageCount">0</h4><p>Abordages Total</p></div>
            <div class="xp-summary-item abordages-today"><h4 id="dailyAbordageCount">0</h4><p>Abordages du Jour</p></div>
            <div class="xp-summary-item"><h4 id="xpToday">0</h4><p>XP du Jour</p></div>
            <div class="xp-summary-item streak"><h4 id="streakDays">0</h4><p>Jours 🔥</p></div>
        </div>
    </section>

    <div class="mode-switcher">
        <button id="ddrModeBtn" class="mode-btn">🔥 DDR</button>
        <button id="echauffementModeBtn" class="mode-btn">💪 Échauffement</button>
    </div>

    <main>
        <div id="ddrModeContainer" class="mode-container">
            <p class="intro-text">Prêt à passer à l'action ?</p>
            <button id="newInteractionBtn">Nouvelle Interaction</button>
        </div>
        <div id="echauffementModeContainer" class="mode-container">
            <p class="intro-text">Choisis une action simple pour t'échauffer :</p>
            <div id="actionsGrid" class="actions-grid"></div>
        </div>
    </main>

    <section id="dailyChallengeSection" class="daily-challenge" style="display:none;">
        <h3>🎯 Défi du Jour</h3>
        <p id="dailyChallengeDescription"></p>
        <button id="dailyChallengeBtn" class="daily-challenge-btn"></button>
    </section>

    <div class="divider"></div>

    <div class="action-buttons">
        <button id="undoBtn">Annuler la dernière action</button>
    </div>

    <div class="instructions">
        <strong>Conseil :</strong> Ajoutez cette page à votre écran d'accueil pour un accès rapide !
    </div>
</div>

<div id="sideMenuModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" data-close>&times;</span>
        <h2>Menu</h2>
        <div class="menu-links">
            <button class="action-btn full-width" data-modal-target="badgesModal">
                <div class="btn-content"><span class="btn-emoji">🏆</span><span>Mes Badges</span></div>
            </button>
            <button class="action-btn full-width" data-modal-target="statsModal">
                <div class="btn-content"><span class="btn-emoji">📊</span><span>Statistiques</span></div>
            </button>
            <button id="exportBtn" class="action-btn full-width">
                <div class="btn-content"><span class="btn-emoji">⬇️</span><span>Exporter la progression</span></div>
            </button>
            <button id="shareScoreBtn" class="action-btn full-width">
                <div class="btn-content"><span class="btn-emoji">📲</span><span>Partager mon score</span></div>
            </button>
        </div>
        <button id="resetBtn" class="action-btn full-width" style="color:#ef4444;border-color:#ef4444;background:#fee2e2;margin-top:20px;">Réinitialiser la progression</button>
    </div>
</div>

<div id="badgesModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" data-close>&times;</span>
        <h2>🏆 Mes Badges</h2>
        <div id="badgesGrid" class="badges-grid"></div>
    </div>
</div>

<div id="statsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" data-close>&times;</span>
        <h2>📊 Statistiques</h2>
        <div id="statsContent" class="stats-content">
            <h3>Résumé</h3>
            <ul>
                <li><span>XP total gagné</span><span id="totalXPStat">0 XP</span></li>
                <li><span>Nombre d'actions</span><span id="totalActionsStat">0</span></li>
            </ul>
            <h3>Historique Récent</h3>
            <ul id="historyList"></ul>
            <button id="exportStatsBtn" class="export-btn-modal">Exporter les statistiques</button>
        </div>
    </div>
</div>

<div id="ddrModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" data-close>&times;</span>
        <h2>🔥 Nouvelle Interaction</h2>
        <div class="ddr-step">
            <h3>Étape 1 : Type de fille</h3>
            <div class="girl-types" id="girlTypesContainer"></div>
        </div>
        <div class="ddr-step">
            <h3>Étape 2 : Actions réalisées</h3>
            <div class="ddr-actions-list" id="ddrActionsContainer"></div>
        </div>
        <button id="ddrSubmitBtn">Valider et Gagner l'XP</button>
    </div>
</div>

<div id="xpPopup" class="xp-popup"></div>
<div id="badgeUnlockedPopup" class="badge-unlocked-popup">
    <div id="badgeEmoji" class="emoji"></div>
    <h3>NOUVEAU BADGE</h3>
    <p id="badgeName"></p>
</div>

<audio id="soundEffect" src="https://assets.mixkit.co/sfx/preview/mixkit-game-level-up-2059.mp3" preload="auto"></audio>
<audio id="badgeSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const XP_BASE = 100;
    const XP_FACTOR = 1.5;

    const ECHAUFFEMENT_ACTIONS = [
        { id: 'askTime', name: 'Demander l\'heure', xp: 5, emoji: '🕒' },
        { id: 'askTissue', name: 'Demander un mouchoir', xp: 10, emoji: '🤧' },
        { id: 'askInfo', name: 'Demander un renseignement', xp: 15, emoji: '❓' },
        { id: 'quickInteraction', name: 'Interaction rapide', xp: 20, emoji: '💬' }
    ].sort((a, b) => a.xp - b.xp);

    const DDR_GIRL_TYPES = [
        { id: 'normal', name: 'Fille normale', emoji: '👩', multiplier: 1.0 },
        { id: '7plus', name: '7-8/10', emoji: '💃', multiplier: 1.5 },
        { id: '9plus', name: '9-10/10', emoji: '👑', multiplier: 2.0 }
    ];

    const DDR_ACTIONS = [
        { id: 'sourire', name: 'La faire sourire', xp: 5, emoji: '😊' },
        { id: 'abordage', name: 'Abordage contextuel', xp: 10, emoji: '👋' },
        { id: 'donnerContact', name: 'Donner son contact', xp: 10, emoji: '📤' },
        { id: 'compliment', name: 'Faire un compliment', xp: 15, emoji: '😍' },
        { id: 'convCourte', name: 'Conversation < 2 min', xp: 20, emoji: '🗣️' },
        { id: 'rire', name: 'La faire rire', xp: 25, emoji: '😂' },
        { id: 'bise', name: 'Faire la bise', xp: 25, emoji: '😘' },
        { id: 'tactile', name: 'Être tactile', xp: 30, emoji: '🖐️' },
        { id: 'convLongue', name: 'Conversation longue', xp: 30, emoji: '💬' },
        { id: 'complicite', name: 'Créer une complicité', xp: 35, emoji: '😉' },
        { id: 'instagram', name: 'Obtenir l\'Instagram', xp: 40, emoji: '📸' },
        { id: 'duo', name: 'Abordage duo', xp: 50, emoji: '👥' },
        { id: 'whatsapp', name: 'Obtenir WhatsApp/Num', xp: 60, emoji: '📱' },
        { id: 'trio', name: 'Abordage trio', xp: 70, emoji: '👨‍👩‍👧' },
        { id: 'groupe', name: 'Abordage groupe (+3)', xp: 90, emoji: '👨‍👩‍👧‍👦' },
        { id: 'bisou', name: 'Obtenir un bisou', xp: 120, emoji: '💋' },
        { id: 'instantDate', name: 'Instant date', xp: 150, emoji: '☕' },
        { id: 'ramener', name: 'Ramener la fille chez soi', xp: 250, emoji: '🔥' }
    ].sort((a, b) => a.xp - b.xp);

    const BADGES = [
        { id: 'debutant', type: 'stat', stat: 'abordages', requirement: 1, name: 'Débutant Courageux', emoji: '🐣' },
        { id: 'level3', type: 'level', requirement: 3, name: 'Premier Pas', emoji: '👟' },
        { id: 'level5', type: 'level', requirement: 5, name: 'Explorateur Social', emoji: '🧭' },
        { id: 'chasseurNumero', type: 'stat', stat: 'whatsapp', requirement: 10, name: 'Chasseur de numéros', emoji: '🏆' },
        { id: 'level10', type: 'level', requirement: 10, name: 'Sans Peur', emoji: '💪' },
        { id: 'influenceurIRL', type: 'stat', stat: 'instagram', requirement: 10, name: 'Influenceur IRL', emoji: '📸' },
        { id: 'seducteur', type: 'stat', stat: 'bisous', requirement: 1, name: 'Séducteur Légendaire', emoji: '💋' }
    ];

    const DAILY_CHALLENGES = [
        { name: 'Ose dire bonjour à 5 personnes aujourd\'hui', xp: 100 },
        { name: 'Demande l\'heure à une inconnue', xp: 80 },
        { name: 'Transforme une petite interaction en grosse', xp: 120 },
        { name: 'Essaie d\'obtenir un prénom', xp: 150 },
        { name: 'Fais une conversation de 3 minutes minimum', xp: 200 }
    ];

    // --- DOM Elements ---
    const dom = {
        appContainer: document.getElementById('appContainer'),
        levelNumber: document.getElementById('levelNumber'),
        progressFill: document.getElementById('progressFill'),
        xpBar: document.getElementById('xpBar'),
        currentXP: document.getElementById('currentXP'),
        nextLevelXP: document.getElementById('nextLevelXP'),
        totalAbordageCount: document.getElementById('totalAbordageCount'),
        dailyAbordageCount: document.getElementById('dailyAbordageCount'),
        xpToday: document.getElementById('xpToday'),
        streakDays: document.getElementById('streakDays'),
        xpPopup: document.getElementById('xpPopup'),
        badgeUnlockedPopup: document.getElementById('badgeUnlockedPopup'),
        badgeEmoji: document.getElementById('badgeEmoji'),
        badgeName: document.getElementById('badgeName'),
        sideMenuModal: document.getElementById('sideMenuModal'),
        badgesModal: document.getElementById('badgesModal'),
        statsModal: document.getElementById('statsModal'),
        ddrModal: document.getElementById('ddrModal'),
        ddrModeContainer: document.getElementById('ddrModeContainer'),
        echauffementModeContainer: document.getElementById('echauffementModeContainer'),
        actionsGrid: document.getElementById('actionsGrid'),
        badgesGrid: document.getElementById('badgesGrid'),
        historyList: document.getElementById('historyList'),
        girlTypesContainer: document.getElementById('girlTypesContainer'),
        ddrActionsContainer: document.getElementById('ddrActionsContainer'),
        modeSwitcher: document.querySelector('.mode-switcher'),
        newInteractionBtn: document.getElementById('newInteractionBtn'),
        undoBtn: document.getElementById('undoBtn'),
        menuBtn: document.getElementById('menuBtn'),
        ddrSubmitBtn: document.getElementById('ddrSubmitBtn'),
        totalXPStat: document.getElementById('totalXPStat'),
        totalActionsStat: document.getElementById('totalActionsStat'),
        soundEffect: document.getElementById('soundEffect'),
        badgeSound: document.getElementById('badgeSound'),
        dailyChallengeSection: document.getElementById('dailyChallengeSection'),
        dailyChallengeDescription: document.getElementById('dailyChallengeDescription'),
        dailyChallengeBtn: document.getElementById('dailyChallengeBtn'),
    };

    // --- State ---
    let player = {};
    let actionHistory = [];

    const resetPlayerState = () => ({
        level: 1,
        xp: 0,
        history: [], // Maintenu pour la compatibilité, mais la nouvelle gestion est plus robuste
        lastXPDate: null,
        currentStreak: 0,
        unlockedBadges: [],
        stats: { abordages: 0, whatsapp: 0, instagram: 0, bisous: 0 },
        dailyStats: { date: null, xp: 0, abordages: 0 },
        mode: 'ddr',
        dailyChallenge: null,
        lastChallengeDate: null,
    });

    // --- Data Persistence ---
    const saveData = () => {
        try {
            localStorage.setItem('socialXPPlayer', JSON.stringify(player));
            localStorage.setItem('socialXPActionHistory', JSON.stringify(actionHistory));
        } catch (e) {
            console.error("Failed to save data:", e);
        }
    };

    const loadData = () => {
        try {
            const savedPlayer = localStorage.getItem('socialXPPlayer');
            const savedHistory = localStorage.getItem('socialXPActionHistory');
            player = savedPlayer ? JSON.parse(savedPlayer) : resetPlayerState();
            // Assurer que les nouvelles propriétés existent
            player.dailyStats = player.dailyStats || { date: null, xp: 0, abordages: 0 };
            player.stats = player.stats || { abordages: 0, whatsapp: 0, instagram: 0, bisous: 0 };

            actionHistory = savedHistory ? JSON.parse(savedHistory) : [];
        } catch (e) {
            console.error("Failed to load data, resetting state:", e);
            player = resetPlayerState();
            actionHistory = [];
        }
    };

    // --- Core Logic ---
    const getXPNeededForNextLevel = level => Math.floor(XP_BASE * Math.pow(XP_FACTOR, level - 1));

    const grantXP = (amount, type, details = {}, options = { isAbordage: false }) => {
        if (amount <= 0) return;

        const stateBefore = JSON.parse(JSON.stringify(player));
        
        player.xp += amount;
        player.dailyStats.xp += amount;
        
        if (options.isAbordage) {
            player.stats.abordages = (player.stats.abordages || 0) + 1;
            player.dailyStats.abordages = (player.dailyStats.abordages || 0) + 1;
        }
        
        updateStreak();

        const historyEntry = { stateBefore, amount, type, details, options, timestamp: Date.now() };
        actionHistory.push(historyEntry);
        if (actionHistory.length > 20) actionHistory.shift();

        let leveledUp = false;
        let xpNeeded = getXPNeededForNextLevel(player.level);
        while (player.xp >= xpNeeded) {
            player.level++;
            player.xp -= xpNeeded;
            leveledUp = true;
            xpNeeded = getXPNeededForNextLevel(player.level);
            checkBadges();
        }

        if (leveledUp) {
            dom.soundEffect.play().catch(e => console.log("Audio play failed:", e));
            dom.levelNumber.classList.add('level-up');
            setTimeout(() => dom.levelNumber.classList.remove('level-up'), 500);
        }

        showXpPopup(amount);
        updateUI();
        checkBadges();
        saveData();
    };
    
    const undoLastAction = () => {
        if (actionHistory.length === 0) {
            alert("Aucune action à annuler.");
            return;
        }

        const lastAction = actionHistory.pop();
        if (lastAction && lastAction.stateBefore) {
            player = JSON.parse(JSON.stringify(lastAction.stateBefore));
            updateUI();
            saveData();
            alert("Dernière action annulée !");
        }
    };
    
    // --- UI Update ---
    const updateUI = () => {
        // Level and XP Circle
        dom.levelNumber.textContent = player.level;
        const xpNeeded = getXPNeededForNextLevel(player.level);
        const progressPercent = player.xp / xpNeeded;
        const circumference = 194.78;
        dom.progressFill.style.strokeDashoffset = circumference * (1 - progressPercent);
        
        // XP Bar
        dom.xpBar.style.width = `${progressPercent * 100}%`;
        dom.currentXP.textContent = `${Math.floor(player.xp)} XP`;
        dom.nextLevelXP.textContent = `${xpNeeded} XP`;

        // Summary Stats
        dom.totalAbordageCount.textContent = player.stats.abordages || 0;
        dom.dailyAbordageCount.textContent = player.dailyStats.abordages || 0;
        dom.xpToday.textContent = player.dailyStats.xp || 0;
        dom.streakDays.textContent = player.currentStreak || 0;

        // Modals
        updateStatsModal();
        populateBadges();
        
        // Buttons
        dom.undoBtn.disabled = actionHistory.length === 0;
    };

    const showXpPopup = (amount) => {
        dom.xpPopup.textContent = `+${amount} XP`;
        dom.xpPopup.classList.add('show');
        setTimeout(() => {
            dom.xpPopup.classList.remove('show');
        }, 1500);
    };

    // --- Date & Streak Management ---
    const getTodayDateString = () => {
        const today = new Date();
        return today.toISOString().split('T')[0];
    };
    
    const checkDailyReset = () => {
        const todayStr = getTodayDateString();
        if (player.dailyStats.date !== todayStr) {
            // Check streak before resetting
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (player.dailyStats.date !== yesterdayStr) {
                player.currentStreak = 0; // Streak broken
            }

            // Reset daily stats
            player.dailyStats = {
                date: todayStr,
                xp: 0,
                abordages: 0
            };
        }
    };
    
    const updateStreak = () => {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        if (!player.lastXPDate) {
            player.currentStreak = 1;
        } else {
            const lastDate = new Date(player.lastXPDate);
            const diffTime = today - lastDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                player.currentStreak++;
            } else if (diffDays > 1) {
                player.currentStreak = 1; // Streak reset
            }
            // If diffDays is 0, do nothing (same day)
        }
        player.lastXPDate = todayStr;
    };


    // --- Mode Switcher ---
    const switchMode = (mode) => {
        player.mode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.mode-container').forEach(c => c.classList.remove('active'));
        if (mode === 'ddr') {
            document.getElementById('ddrModeBtn').classList.add('active');
            dom.ddrModeContainer.classList.add('active');
        } else {
            document.getElementById('echauffementModeBtn').classList.add('active');
            dom.echauffementModeContainer.classList.add('active');
        }
        saveData();
    };

    // --- Modal Management ---
    let openModals = [];

    const openModal = (modal) => {
        if (!modal) return;
        if (openModals.length === 0) {
             const scrollY = window.scrollY;
             document.body.style.setProperty('--scroll-y', `-${scrollY}px`);
             document.body.classList.add('modal-open');
        }
        modal.classList.add('visible');
        openModals.push(modal);
    };

    const closeModal = (modal) => {
        if (!modal) return;
        modal.classList.remove('visible');
        openModals = openModals.filter(m => m !== modal);

        if (openModals.length === 0) {
            const scrollY = document.body.style.getPropertyValue('--scroll-y');
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('--scroll-y');
            if (scrollY) {
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }
        }
    };
    
    // --- Populators ---
    const populateActions = () => {
        dom.actionsGrid.innerHTML = '';
        ECHAUFFEMENT_ACTIONS.forEach(action => {
            const button = document.createElement('button');
            button.className = 'action-btn';
            button.dataset.actionId = action.id;
            button.innerHTML = `
                <div class="btn-content">
                    <span class="btn-emoji">${action.emoji}</span>
                    <span>${action.name}</span>
                </div>
                <span class="btn-xp">+${action.xp} XP</span>
            `;
            dom.actionsGrid.appendChild(button);
        });
    };
    
    const populateDdrModal = () => {
        dom.girlTypesContainer.innerHTML = '';
        DDR_GIRL_TYPES.forEach(type => {
            const label = document.createElement('label');
            label.className = 'girl-type';
            label.innerHTML = `
                <input type="radio" name="girlType" value="${type.id}">
                <div class="emoji">${type.emoji}</div>
                <span>${type.name}</span>
                <p>x${type.multiplier}</p>
            `;
            dom.girlTypesContainer.appendChild(label);
        });

        dom.ddrActionsContainer.innerHTML = '';
        DDR_ACTIONS.forEach(action => {
            const label = document.createElement('label');
            label.className = 'action-checkbox-label';
            label.innerHTML = `
                <input type="checkbox" value="${action.id}">
                <div class="custom-checkbox"></div>
                <div class="content">
                    <span class="emoji">${action.emoji}</span>
                    <span>${action.name}</span>
                </div>
                <span class="xp-tag">+${action.xp}</span>
            `;
            dom.ddrActionsContainer.appendChild(label);
        });
    };

    const populateBadges = () => {
        dom.badgesGrid.innerHTML = '';
        BADGES.forEach(badge => {
            const isUnlocked = player.unlockedBadges.includes(badge.id);
            const badgeEl = document.createElement('div');
            badgeEl.className = `badge-item ${isUnlocked ? 'unlocked' : ''}`;
            badgeEl.innerHTML = `<div class="emoji">${badge.emoji}</div><p>${badge.name}</p>`;
            dom.badgesGrid.appendChild(badgeEl);
        });
    };
    
    const updateStatsModal = () => {
        let totalXp = player.xp;
        for (let i = 1; i < player.level; i++) {
            totalXp += getXPNeededForNextLevel(i);
        }
        dom.totalXPStat.textContent = `${Math.floor(totalXp)} XP`;
        dom.totalActionsStat.textContent = actionHistory.length;

        dom.historyList.innerHTML = '';
        [...actionHistory].reverse().slice(0, 5).forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${item.type}</span><span>+${item.amount} XP</span>`;
            dom.historyList.appendChild(li);
        });
    };

    // --- Badge Logic ---
    const checkBadges = () => {
        BADGES.forEach(badge => {
            if (player.unlockedBadges.includes(badge.id)) return;

            let unlocked = false;
            if (badge.type === 'level' && player.level >= badge.requirement) {
                unlocked = true;
            } else if (badge.type === 'stat') {
                const statValue = player.stats[badge.stat] || 0;
                if (statValue >= badge.requirement) {
                    unlocked = true;
                }
            }

            if (unlocked) {
                player.unlockedBadges.push(badge.id);
                showBadgePopup(badge);
            }
        });
    };

    const showBadgePopup = (badge) => {
        dom.badgeEmoji.textContent = badge.emoji;
        dom.badgeName.textContent = badge.name;
        dom.badgeUnlockedPopup.classList.add('show');
        dom.badgeSound.play().catch(e => console.log("Badge audio failed:", e));

        // Confetti effect
        for (let i = 0; i < 50; i++) {
            createConfetti();
        }

        setTimeout(() => {
            dom.badgeUnlockedPopup.classList.remove('show');
        }, 3000);
    };

    const createConfetti = () => {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.animationDuration = `${Math.random() * 2 + 3}s`;
        confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 5000);
    };

    // --- Daily Challenge ---
    const setupDailyChallenge = () => {
        const todayStr = getTodayDateString();
        if (player.lastChallengeDate !== todayStr) {
            const challengeIndex = new Date(todayStr).getDate() % DAILY_CHALLENGES.length;
            player.dailyChallenge = { ...DAILY_CHALLENGES[challengeIndex], completed: false };
            player.lastChallengeDate = todayStr;
        }

        if (player.dailyChallenge) {
            dom.dailyChallengeDescription.textContent = player.dailyChallenge.name;
            dom.dailyChallengeBtn.textContent = `Valider (+${player.dailyChallenge.xp} XP)`;
            dom.dailyChallengeBtn.disabled = player.dailyChallenge.completed;
            dom.dailyChallengeSection.style.display = 'block';
        } else {
            dom.dailyChallengeSection.style.display = 'none';
        }
    };
    
    // --- Event Listeners ---
    const setupEventListeners = () => {
        dom.modeSwitcher.addEventListener('click', e => {
            if (e.target.id === 'ddrModeBtn') switchMode('ddr');
            if (e.target.id === 'echauffementModeBtn') switchMode('echauffement');
        });

        // Event delegation for "Échauffement" actions
        dom.echauffementModeContainer.addEventListener('click', e => {
            const btn = e.target.closest('.action-btn');
            if (!btn) return;
            const actionId = btn.dataset.actionId;
            const action = ECHAUFFEMENT_ACTIONS.find(a => a.id === actionId);
            if (action) {
                grantXP(action.xp, action.name, {}, { isAbordage: true });
            }
        });

        dom.newInteractionBtn.addEventListener('click', () => openModal(dom.ddrModal));

        dom.ddrSubmitBtn.addEventListener('click', () => {
            const selectedTypeEl = dom.girlTypesContainer.querySelector('input:checked');
            if (!selectedTypeEl) {
                alert("Veuillez sélectionner un type de fille.");
                return;
            }
            const type = DDR_GIRL_TYPES.find(t => t.id === selectedTypeEl.value);
            const multiplier = type.multiplier;

            let totalXP = 0;
            const selectedActions = [];
            dom.ddrActionsContainer.querySelectorAll('input:checked').forEach(checkbox => {
                const action = DDR_ACTIONS.find(a => a.id === checkbox.value);
                totalXP += action.xp;
                selectedActions.push(action.name);
            });
            
            if (totalXP === 0) {
                 alert("Veuillez sélectionner au moins une action.");
                return;
            }

            const finalXP = Math.round(totalXP * multiplier);
            grantXP(finalXP, 'Interaction DDR', { actions: selectedActions, multiplier }, { isAbordage: true });

            closeModal(dom.ddrModal);
            // Reset form
            selectedTypeEl.checked = false;
            dom.girlTypesContainer.querySelector('.selected')?.classList.remove('selected');
            dom.ddrActionsContainer.querySelectorAll('input:checked').forEach(c => c.checked = false);
        });

        // Event delegation for DDR modal inputs
        dom.girlTypesContainer.addEventListener('click', e => {
            const label = e.target.closest('.girl-type');
            if (label) {
                dom.girlTypesContainer.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                label.classList.add('selected');
                const radio = label.querySelector('input');
                if(radio) radio.checked = true;
            }
        });
        
        dom.menuBtn.addEventListener('click', () => openModal(dom.sideMenuModal));
        dom.undoBtn.addEventListener('click', undoLastAction);
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            if (confirm("Êtes-vous sûr de vouloir réinitialiser toute votre progression ? Cette action est irréversible.")) {
                localStorage.removeItem('socialXPPlayer');
                localStorage.removeItem('socialXPActionHistory');
                player = resetPlayerState();
                actionHistory = [];
                location.reload();
            }
        });
        
        document.getElementById('exportBtn').addEventListener('click', () => {
            const dataStr = JSON.stringify({ player, actionHistory }, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `xp-social-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        dom.dailyChallengeBtn.addEventListener('click', e => {
            if (!player.dailyChallenge.completed) {
                grantXP(player.dailyChallenge.xp, "Défi du jour", { name: player.dailyChallenge.name });
                player.dailyChallenge.completed = true;
                e.target.disabled = true;
                saveData();
            }
        });

        // Global listeners for modals
        document.addEventListener('click', e => {
            if (e.target.dataset.modalTarget) {
                const modal = document.getElementById(e.target.dataset.modalTarget);
                openModal(modal);
            }
            if (e.target.hasAttribute('data-close')) {
                closeModal(e.target.closest('.modal'));
            }
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && openModals.length > 0) {
                closeModal(openModals[openModals.length - 1]);
            }
        });
    };

    // --- Initialization ---
    const init = () => {
        loadData();
        checkDailyReset();
        switchMode(player.mode || 'ddr');
        populateActions();
        populateDdrModal();
        setupDailyChallenge();
        setupEventListeners();
        updateUI();
    };

    init();
});
</script>
</body>
</html>
